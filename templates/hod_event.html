<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ event.title }} - Review | Attendance System</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/hod_event.css') }}">
</head>
<body>
  <div class="container-custom">
    <div class="fade-in">
      <!-- Event Info Header -->
      <div class="event-info-card">
        <div class="d-flex justify-between align-center flex-wrap gap-2 mb-3">
          <h1 style="margin: 0;">{{ event.title }}</h1>
          <a href="{{ url_for('dashboard') }}" class="btn-custom btn-secondary-custom btn-sm-custom" style="background: rgba(255,255,255,0.2); color: white; border: none;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="19" y1="12" x2="5" y2="12"/>
              <polyline points="12 19 5 12 12 5"/>
            </svg>
            Back
          </a>
        </div>
        <div class="event-meta">
          <div class="event-meta-item">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
              <circle cx="12" cy="10" r="3"/>
            </svg>
            {{ event.location }}
          </div>
          <div class="event-meta-item">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
              <line x1="16" y1="2" x2="16" y2="6"/>
              <line x1="8" y1="2" x2="8" y2="6"/>
              <line x1="3" y1="10" x2="21" y2="10"/>
            </svg>
            {{ event.when_dt }}
          </div>
        </div>
        {% if event.description %}
        <p style="margin-top: 16px; margin-bottom: 0; opacity: 0.95;">{{ event.description }}</p>
        {% endif %}
      </div>

      <div class="card-custom">
        <!-- Approval Stats -->
        <div class="approval-stats">
          <div class="stat-box">
            <div id="stat-total" class="stat-box-number">{{ rows|length }}</div>
            <div class="stat-box-label">Total Records</div>
          </div>
          <div class="stat-box approved">
            <div id="stat-approved" class="stat-box-number">{{ rows|selectattr('status', 'equalto', 'Approved')|list|length }}</div>
            <div class="stat-box-label">Approved</div>
          </div>
          <div class="stat-box pending">
            <div id="stat-pending" class="stat-box-number">{{ rows|selectattr('status', 'equalto', 'Pending')|list|length }}</div>
            <div class="stat-box-label">Pending Review</div>
          </div>
          <div class="stat-box rejected">
            <div id="stat-rejected" class="stat-box-number">{{ rows|selectattr('status', 'equalto', 'Rejected')|list|length }}</div>
            <div class="stat-box-label">Rejected</div>
          </div>
        </div>

        <!-- Attendance Table -->
        <div style="display:flex; gap:8px; margin-bottom:12px; align-items:center;">
          <button class="btn-custom btn-success-custom btn-sm-custom" onclick="bulkAction('Approved')">Approve Selected</button>
          <button class="btn-custom btn-danger-custom btn-sm-custom" onclick="bulkAction('Rejected')">Reject Selected</button>
          <button class="btn-custom btn-warning-custom btn-sm-custom" onclick="bulkAction('Pending')">Mark Selected Pending</button>
          <div style="margin-left:auto;">Sort: <a href="?sort=roll">Roll</a> | <a href="?sort=scanned_at">Scanned At</a></div>
        </div>
        <div class="mt-4">
          <h3 class="heading-tertiary mb-3">Attendance Records</h3>
          {% if rows %}
          <div class="table-responsive">
            <table class="table-custom">
              <thead>
                <tr>
                  <th style="width:40px"><input type="checkbox" id="selectAll" onclick="toggleAll(this)"></th>
                  <th>Roll Number</th>
                  <th>Student Name</th>
                  <th>Branch</th>
                  <th>Scanned At</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for r in rows %}
                <tr id="row-{{ r.id }}">
                  <td><input type="checkbox" class="sel" value="{{ r.id }}"></td>
                  <td><strong>{{ r.roll }}</strong></td>
                  <td>{{ r.student_name or "Unknown" }}</td>
                  <td>{{ r.branch or "-" }}</td>
                  <td>{{ r.scanned_at }}</td>
                  <td>
                    <span id="status-{{ r.id }}" class="status-badge status-{{ r.status|lower }}">
                      {{ r.status }}
                    </span>
                  </td>
                  <td>
                    <div class="action-buttons">
                      <button class="btn-custom btn-success-custom btn-sm-custom" 
                              id="Approve-{{ r.id }}" 
                              onclick="hodAction({{ r.id }}, 'Approved')"
                              style="{% if r.status == 'Approved' %}display: none;{% endif %}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <polyline points="20 6 9 17 4 12"/>
                        </svg>
                        Approve
                      </button>
                      <button class="btn-custom btn-warning-custom btn-sm-custom" 
                              id="Review-{{ r.id }}" 
                              onclick="hodAction({{ r.id }}, 'Pending')"
                              style="{% if r.status == 'Pending' %}display: none;{% endif %}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <circle cx="12" cy="12" r="10"/>
                          <line x1="12" y1="8" x2="12" y2="12"/>
                          <line x1="12" y1="16" x2="12.01" y2="16"/>
                        </svg>
                        Review
                      </button>
                      <button class="btn-custom btn-danger-custom btn-sm-custom" 
                              id="Reject-{{ r.id }}" 
                              onclick="hodAction({{ r.id }}, 'Rejected')"
                              style="{% if r.status == 'Rejected' %}display: none;{% endif %}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <circle cx="12" cy="12" r="10"/>
                          <line x1="15" y1="9" x2="9" y2="15"/>
                          <line x1="9" y1="9" x2="15" y2="15"/>
                        </svg>
                        Reject
                      </button>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div style="text-align: center; padding: 40px; color: var(--text-muted);">
            <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="opacity: 0.5; margin-bottom: 12px;">
              <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
              <circle cx="8.5" cy="7" r="4"/>
              <line x1="23" y1="11" x2="17" y2="11"/>
            </svg>
            <p>No attendance records to review yet.</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <script>
  function toggleAll(cb){
    const checked = cb.checked;
    document.querySelectorAll('input.sel').forEach(i => i.checked = checked);
  }

  function getSelectedIds(){
    return Array.from(document.querySelectorAll('input.sel:checked')).map(i => i.value);
  }

  function bulkAction(action){
    const ids = getSelectedIds();
    if(!ids.length){
      alert('Please select at least one record');
      return;
    }
    if(!confirm(`Perform '${action}' on ${ids.length} selected records?`)) return;
    fetch('/hod_bulk_action',{
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({attendance_ids: ids, action: action})
    }).then(r=>r.json()).then(js=>{
      if(js.ok){
        // reload to reflect changes
        location.reload();
      } else {
        alert('Error performing bulk action');
      }
    }).catch(e=>{console.error(e); alert('Network error')});
  }

  function hodAction(attId, action) {
    const statusCell = document.getElementById("status-" + attId);
    const ApproveBtn = document.getElementById("Approve-" + attId);
    const ReviewBtn = document.getElementById("Review-" + attId);
    const RejectBtn = document.getElementById("Reject-" + attId);

    // capture previous status to update stats counts
    const prevStatus = statusCell ? statusCell.innerText.trim() : null;

    fetch("/hod_action", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ attendance_id: attId, action: action })
    })
    .then(r => r.json())
    .then(js => {
      if(js.ok){
        // Update status badge
        statusCell.innerText = action;
        statusCell.className = "status-badge status-" + action.toLowerCase();

        // Show/hide buttons based on new status
        ApproveBtn.style.display = action === "Approved" ? "none" : "inline-flex";
        ReviewBtn.style.display = action === "Pending" ? "none" : "inline-flex";
        RejectBtn.style.display = action === "Rejected" ? "none" : "inline-flex";

        // Update counts in the stats widgets without full reload
        try {
          function updateCount(id, delta) {
            const el = document.getElementById(id);
            if(!el) return;
            el.textContent = (parseInt(el.textContent) || 0) + delta;
          }
          const mapId = { 'Approved': 'stat-approved', 'Pending': 'stat-pending', 'Rejected': 'stat-rejected' };
          if (prevStatus && prevStatus !== action) {
            // decrement previous
            const prevId = mapId[prevStatus] || null;
            const newId = mapId[action] || null;
            if (prevId) updateCount(prevId, -1);
            if (newId) updateCount(newId, 1);
          }
        } catch (e) { console.error('Error updating stats:', e); }

      } else {
        alert("Error updating attendance status.");
      }
    })
    .catch(err => {
      console.error("Error:", err);
      alert("Network or server error occurred.");
    });
  }
  </script>

  <script src="{{ url_for('static', filename='js/theme-toggle.js') }}"></script>
</body>
</html>