<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ event.title }} | Attendance System</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/organiser_event.css') }}">
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>
  <div class="container-custom">
    <div class="fade-in">
      <!-- Event Info Header -->
      <div class="event-info-card">
        <div class="d-flex justify-between align-center flex-wrap gap-2 mb-3">
          <h1 style="margin: 0;">{{ event.title }}</h1>
          <a href="{{ url_for('dashboard') }}" class="btn-custom btn-secondary-custom btn-sm-custom" style="background: rgba(255,255,255,0.2); color: white; border: none;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="19" y1="12" x2="5" y2="12"/>
              <polyline points="12 19 5 12 12 5"/>
            </svg>
            Back
          </a>
        </div>
        <div class="event-meta">
          <div class="event-meta-item">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
              <circle cx="12" cy="10" r="3"/>
            </svg>
            {{ event.location }}
          </div>
          <div class="event-meta-item">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
              <line x1="16" y1="2" x2="16" y2="6"/>
              <line x1="8" y1="2" x2="8" y2="6"/>
              <line x1="3" y1="10" x2="21" y2="10"/>
            </svg>
            {{ event.when_dt }}
          </div>
        </div>
        {% if event.description %}
        <p style="margin-top: 16px; margin-bottom: 0; opacity: 0.95;">{{ event.description }}</p>
        {% endif %}
      </div>

      <div class="card-custom">
        <!-- Stats -->
        <div class="attendance-stats">
          <div class="stat-box">
            <div id="stat-total" class="stat-box-number">{{ rows|length }}</div>
            <div class="stat-box-label">Total Scans</div>
          </div>
          <div class="stat-box">
            <div id="stat-pending" class="stat-box-number">{{ rows|selectattr('status', 'equalto', 'Pending')|list|length }}</div>
            <div class="stat-box-label">Pending</div>
          </div>
          <div class="stat-box">
            <div id="stat-approved" class="stat-box-number">{{ rows|selectattr('status', 'equalto', 'Approved')|list|length }}</div>
            <div class="stat-box-label">Approved</div>
          </div>
        </div>

        <!-- Scanner Section -->
        <div class="scanner-card" id="scannerCard">
          <h3 class="heading-tertiary">QR Code Scanner</h3>
          <p class="text-muted-custom mb-3">Scan student QR codes to mark attendance</p>
          <button id="startScan" class="btn-custom btn-success-custom">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
              <circle cx="12" cy="13" r="4"/>
            </svg>
            Start Scanning
          </button>
          
          <div id="scanner" class="hidden">
            <div id="reader"></div>
            <button id="stopScan" class="btn-custom btn-danger-custom mt-3">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <line x1="15" y1="9" x2="9" y2="15"/>
                <line x1="9" y1="9" x2="15" y2="15"/>
              </svg>
              Stop Scanner
            </button>
          </div>
        </div>

        <!-- Attendance Table -->
        <div class="mt-4">
          <h3 class="heading-tertiary mb-3">Attendance Records</h3>
          {% if rows %}
          <div class="table-responsive">
            <table class="table-custom">
              <thead>
                <tr>
                  <th>Roll Number</th>
                  <th>Student Name</th>
                  <th>Branch</th>
                  <th>Scanned At (UTC)</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="attendanceTable">
                {% for r in rows %}
                <tr>
                  <td><strong>{{ r.roll }}</strong></td>
                  <td>{{ r.student_name or "Unknown" }}</td>
                  <td>{{ r.branch or "-" }}</td>
                  <td>{{ r.scanned_at }}</td>
                  <td>
                    <span class="status-badge status-{{ r.status|lower }}">
                      {{ r.status }}
                    </span>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div style="text-align: center; padding: 40px; color: var(--text-muted);">
            <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="opacity: 0.5; margin-bottom: 12px;">
              <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
              <circle cx="8.5" cy="7" r="4"/>
              <polyline points="17 11 19 13 23 9"/>
            </svg>
            <p>No attendance records yet. Start scanning to add participants.</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <script>
  const eventId = "{{ event.id }}";
  let html5QrCode = null;
  let lastScanned = null;
  let lastScannedAt = 0;

  function startScanner(){
    document.getElementById("scanner").classList.remove("hidden");
    document.getElementById("scannerCard").classList.add("scanner-active");
    document.getElementById("startScan").style.display = "none";
    document.getElementById("stopScan").style.display = "inline-flex";

    const readerElem = document.getElementById("reader");
    readerElem.innerHTML = "";
    html5QrCode = new Html5Qrcode("reader");

    const config = { fps: 15, qrbox: { width: Math.min(window.innerWidth - 50, 400) } };

    html5QrCode.start({ facingMode: "environment" }, config,
      (decodedText, decodedResult) => {
        // debounce duplicate scans
        const now = Date.now();
        if (decodedText === lastScanned && (now - lastScannedAt) < 3000) {
          return; // ignore duplicate within 3s
        }
        lastScanned = decodedText;
        lastScannedAt = now;

        // Use raw decoded text as roll (per request)
        fetch("/scan_lookup", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ roll: decodedText })
        }).then(res => res.json()).then(data => {
          const name = data.name || "Unknown";
          const branch = data.branch || "Unknown";
          if (confirm(`Scanned: ${decodedText}\nName: ${name}\nBranch: ${branch}\n\nAdd to attendance?`)) {
            fetch("/add_scan", {
              method: "POST",
              headers: {"Content-Type":"application/json"},
              body: JSON.stringify({ event_id: eventId, roll: decodedText })
            }).then(res => res.json()).then(js => {
              const tb = document.getElementById("attendanceTable");
              if (js.row_html) {
                tb.insertAdjacentHTML('afterbegin', js.row_html);
              } else {
                const tr = document.createElement("tr");
                tr.innerHTML = `<td><strong>${decodedText}</strong></td><td>${name}</td><td>${branch}</td><td>${js.scanned_at}</td><td><span class="status-badge status-pending">Pending</span></td>`;
                tb.prepend(tr);
              }

              // Update stats
              try {
                if (js.counts) {
                  const totalEl = document.getElementById('stat-total');
                  const pendingEl = document.getElementById('stat-pending');
                  const approvedEl = document.getElementById('stat-approved');
                  if (totalEl && typeof js.counts.total !== 'undefined') totalEl.textContent = js.counts.total;
                  if (pendingEl && typeof js.counts.pending !== 'undefined') pendingEl.textContent = js.counts.pending;
                  if (approvedEl && typeof js.counts.approved !== 'undefined') approvedEl.textContent = js.counts.approved;
                }
              } catch (e) { console.error('Error updating stats:', e); }
            });
          }
        }).catch(e => console.error('scan_lookup error', e));
      },
      (err) => { /* ignore scan errors silently */ }
    ).catch(err => {
      alert("Camera permission or device error: " + err);
    });
  }

  function stopScanner(){
    if (html5QrCode) {
      html5QrCode.stop().then(() => {
        html5QrCode.clear();
        html5QrCode = null;
        document.getElementById("scanner").classList.add("hidden");
        document.getElementById("scannerCard").classList.remove("scanner-active");
        document.getElementById("startScan").style.display = "inline-flex";
        document.getElementById("stopScan").style.display = "none";
      }).catch(e => {
        console.error('Error stopping scanner', e);
      });
    } else {
      document.getElementById("scanner").classList.add("hidden");
      document.getElementById("scannerCard").classList.remove("scanner-active");
      document.getElementById("startScan").style.display = "inline-flex";
      document.getElementById("stopScan").style.display = "none";
    }
  }

  document.getElementById("startScan").addEventListener("click", startScanner);
  document.getElementById("stopScan").addEventListener("click", stopScanner);
  </script>

  <script src="{{ url_for('static', filename='js/theme-toggle.js') }}"></script>
</body>
</html>